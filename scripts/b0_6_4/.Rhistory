## VISUALISE MISSING VS OBSERVED BOD ##
pdf(paste(pto,"/fig_hist_missing_bod.pdf",sep=""))
#
x = density(bod,na.rm=T)$x
y = density(bod,na.rm=T)$y; y=y/max(y)
plot(x,y,type="l",col="white",xlab="BOD (SU)",ylab="Density (SU)", xaxt="n", yaxt="n", bty="l")
add_axes_and_grid(x, y, alpha=c(1, 0.1))
polygon(x=c(x,rev(x)),y=c(rep(0,length(y)),rev(y)),col=adjustcolor("blue",0.4),border=NA)
#
bod_mis = chainList.argmaxPost(chainList_thinned)[idx_omega_xmis]
x = density(bod_mis,na.rm=T)$x
y = density(bod_mis,na.rm=T)$y; y=y/max(y)
polygon(x=c(x,rev(x)),y=c(rep(0,length(y)),rev(y)),col=adjustcolor("red",0.4),border=NA)
#
legend("topright", legend=c("Observed BOD","Missing BOD"), col=adjustcolor(c("blue","red"),0.4), pch=15, bty="n")
#
dev.off()
## VERIFY MODEL ASSUMPTIONS ##
x_mis_ = apply(chainList.unlist(chainList_thinned)[,-1][,idx_omega_xmis],2,mean)
X_mis_ = X_mis_l * X_mis_r(x_mis_)
chainList_ = list(chainList.unlist(chainList_thinned)[,-1][,idx_omega_beta])
Yhat_obs = chainList.apply(chainList_,function(x)Yhat(X_obs,x))$f_mean
Yhat_mis = chainList.apply(chainList_,function(x)Yhat(X_mis_,x))$f_mean
res_obs = Y_obs - Yhat_obs
res_mis = Y_mis - Yhat_mis
res = c(res_obs, res_mis)
## HISTOGRAM OF RESIDUALS ##
pdf(paste(pto,"/fig_hist_residuals.pdf",sep=""))
#
## plot density observed
x = density(res_obs,na.rm=T)$x
y = density(res_obs,na.rm=T)$y; y=y/max(y)
plot(x,y,type="l",col="white",xlab="Residuals",ylab="Density (SU)", xaxt="n", yaxt="n", bty="l")
add_axes_and_grid(x, y, alpha=c(1, .1))
polygon(x=c(x,rev(x)),y=c(rep(0,length(y)),rev(y)),col=adjustcolor("blue",0.4),border=NA)
#
## plot density missing
x = density(res_mis,na.rm=T)$x
y = density(res_mis,na.rm=T)$y; y=y/max(y)
polygon(x=c(x,rev(x)),y=c(rep(0,length(y)),rev(y)),col=adjustcolor("red",0.4),border=NA)
#
## legend
legend("topright", legend=c("Observed BOD", "Missing BOD"), col=adjustcolor(c("blue","red"),0.4), pch=15, bty="n")
#
dev.off()
## QQ PLOT - v0_2 ##
pdf(paste(pto,"/fig_qqplot_residuals.pdf",sep=""))
par(mfrow=c(1,1), mar=c(3,3,2,2), oma=c(2,2,2,2), xpd=NA)
## compute parameters
sdVect = apply(chainList.unlist(chainList_thinned)[,-1][,idx_omega_sd_lik],2,mean)
rho = apply(chainList.unlist(chainList_thinned)[,-1][,idx_omega_rho],2,mean)
## compute distance matrix
long_obs = long[-idx_mis]
long_mis = long[ idx_mis]
latt_obs = latt[-idx_mis]
latt_mis = latt[ idx_mis]
x_       = c(long_obs,long_mis)
y_       = c(latt_obs,latt_mis)
DM        = matrix(rep(0,length(x_)^2),ncol=length(x_),nrow=length(x_))
for(i in 1:length(x_))
{
for(j in 1:length(y_))
{
DM[i,j] = sqrt((x_[i] - x_[j])^2 + (y_[i] - y_[j])^2)
}
}
## compute sigma
Sigma_ = Sigma(sdVect[idx_sd_lik], rho, DM)
## compute theoretical quantiles
res_th = rmvnorm(n=1, mean=rep(0, n_data), sigma=Sigma_)
## plot
par(xpd=NA)
plot(-1:1, xlim=c(-1,1)*4*sd(res_th), ylim=c(-1,1)*4*sd(res), xlab="Theoretical quantiles", ylab="Residuals", cex=0, xaxt="n", yaxt="n", bty="l")
par(xpd=F)
## grid
x = res_th
y = res
add_axes_and_grid(x, y, alpha=c(1, 1))
## lines
lines(sort(res_th), sort(res), type="p", pch=16, col=gray(runif(n_data, .25, 1), alpha=0.25))
lines((-1:1)*4*sd(res_th),(-1:1)*4*sd(res_th),lty=2)
## legend
# legend("bottomright",legend=c(paste("Bassin ",i,sep=""),"Observed BOD","Missing BOD"),col=adjustcolor(c("white","blue","red"),0.4), pch=1, bty="n")
par(mfrow=c(1,1))
dev.off()
#####
## ##
#####
## goal:
## author: Willem Bonnaffe (w.bonnaffe@gmail.com)
## update log:
## 07-07-2022 - created v0_0
## 11-07-2022 - created v0_1
##            - split missing covariate matrix into left and right component
##            - added plot of the interaction
## 10-09-2022 - created v0_2
##            - updated figures
## 25-08-2023 - created v0_3
##            - improved figures
###############
## FUNCTIONS ##
###############
## add_axis_and_grid
## Goal: Add custom axis and grid to plot given the vector of x and y data.
## Arguments:
## * x - vector - vector of x coordinates of the data to plot
## * x_ - vector - vector of standardised x coordinates of the data to plot
## * y - vector - vector of y coordinates of the data to plot
## * y_ - vector - vector of standardised y coordinates of the data to plot
add_axes_and_grid = function(x, y, alpha)
{
## format data x
alpha_x = alpha[1]
lb_x = floor(min(x)/alpha_x)*alpha_x
rb_x = ceiling(max(x)/alpha_x)*alpha_x
dx = 2.5
x = seq(lb_x, rb_x, dx * alpha_x)
## format data y
alpha_y = alpha[2]
lb_y = floor(min(y)/alpha_y)*alpha_y
rb_y = ceiling(max(y)/alpha_y)*alpha_y
dy = 2.5
y = seq(lb_y, rb_y, dy * alpha_y)
## background
coords = par("usr")
coords_x = coords[1:2]
coords_y = coords[3:4]
polygon(x=c(coords_x, rev(coords_x)), y=c(c(coords_y[1],coords_y[1]), c(coords_y[2],coords_y[2])), col=adjustcolor("lightgrey",alpha=0.2), border=NA)
## grid guides
for (l in 1:length(y)) lines(c(x[1]-10,x[length(x)]+10), c(y[l], y[l]), col="white")
for (l in 1:length(x)) lines(c(x[l], x[l]), c(y[1]-10,y[length(y)]+10), col="white")
## x axis
axis(1, label=x, at=x, lwd=0, lwd.ticks=1)
axis(2, label=y, at=y, lwd=0, lwd.ticks=1)
}
#
###
##############
## INITIATE ##
##############
## load module
source("m1_con_load.r")
## load chains
chainList_ = list()
load(paste(pto,"/chain_thinned_",1,".RData",sep="")); chainList_[[1]] = chainList_thinned[[1]]
load(paste(pto,"/chain_thinned_",2,".RData",sep="")); chainList_[[2]] = chainList_thinned[[1]]
chainList_thinned = chainList_
## VISUALISE PARAMETER POSTERIOR DISTRIBUTIONS ##
chainList_  = list()
for(i in 1:length(chainList_thinned))
{
chain_ = cbind(chainList_thinned[[i]][,1], chainList_thinned[[i]][,-1][,idx_omega_beta])
colnames(chain_) = c("P",colnames(X_obs))
chainList_[[i]] = chain_
}
x_mis_ = apply(chainList.unlist(chainList_thinned)[,-1][,idx_omega_xmis],2,mean)
X_mis_ = X_mis_l * X_mis_r(x_mis_)
chainList_ = list(chainList.unlist(chainList_thinned)[,-1][,idx_omega_beta])
Yhat_obs = chainList.apply(chainList_,function(x)Yhat(X_obs,x))$f_mean
Yhat_mis = chainList.apply(chainList_,function(x)Yhat(X_mis_,x))$f_mean
res_obs = Y_obs - Yhat_obs
res_mis = Y_mis - Yhat_mis
res = c(res_obs, res_mis)
sites = data$station
sites_obs = sites[-idx_mis]
sites_mis = sites[idx_mis]
head(table(sites))
length(table(sites))
barplot(table(sites))
par(mfrow=c(2,1))
barplot(table(sites_obs))
barplot(table(sites_mis))
par(mfrow=c(1,1))
## Looking at one site
site = sites_obs[1]
res_obs_ = res_obs[which(sites_obs == site)]
plot(res_obs_)
site = sites_obs[2]
res_obs_ = res_obs[which(sites_obs == site)]
plot(res_obs_)
site = sites_obs[10]
res_obs_ = res_obs[which(sites_obs == site)]
plot(res_obs_)
site
which(sites_obs == site)
site = sites_obs[14]
res_obs_ = res_obs[which(sites_obs == site)]
plot(res_obs_)
which(table(sites_obs) > 1)
idx_msample_obs = which(table(sites_obs) > 1)
idx_msample_mis = which(table(sites_mis) > 1)
idx_msample_obs[1]
sites_obs[idx_msample_obs[1]]
## Looking at one site
site = sites_obs[idx_msample_obs[1]]
site
sites_obs == site
which(sites_obs == site)
site
par(mfrow=c(2,1))
barplot(table(sites_obs))
barplot(table(sites_mis))
par(mfrow=c(1,1))
head(names(table(sites_obs)))
## Getting multiple sample sites
idx_msample_obs = which(table(sites_obs) > 1)
idx_msample_mis = which(table(sites_mis) > 1)
sites_obs_msampled = names(table(sites_obs))[idx_msample_obs]
sites_mis_msampled = names(table(sites_mis))[idx_msample_mis]
site = sites_obs_msampled[1]
res_obs_ = res_obs[which(sites_obs == site)]
plot(res_obs_)
plot(res_obs_, type="l")
## Looking at one site
for (i in 1:10)
plot(1:10, cex=0, ylim=c(-3,3), xlim=c(0,12))
plot(1:10, cex=0, ylim=c(-3,3), xlim=c(0,12))
for (i in 1:10)
{
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
lines(1:length(res_obs_), res_obs_)
}
plot(1:100, cex=0, ylim=c(-3,3), xlim=c(0,12))
for (i in 1:10)
{
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
lines(1:length(res_obs_), res_obs_)
}
plot(1:10, cex=0, ylim=c(-3,3), xlim=c(0,12))
for (i in 1:100)
{
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
lines(1:length(res_obs_), res_obs_)
}
plot(1:10, cex=0, ylim=c(-3,3), xlim=c(0,12))
for (i in 1:100)
{
col = rainbow(100)[round(runif(1,100))]
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
lines(1:length(res_obs_), res_obs_, col=col)
}
round(runif(1,100))
round(runif(1,1,100))
round(runif(1,1,100))
round(runif(1,1,100))
round(runif(1,1,100))
round(runif(1,1,100))
round(runif(1,1,100))
plot(1:10, cex=0, ylim=c(-3,3), xlim=c(0,12))
for (i in 1:100)
{
col = rainbow(100)[round(runif(1,1,100))]
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
lines(1:length(res_obs_), res_obs_, col=col)
}
res_obs_[-1]
res_obs_
res_obs_l = c(NA, res_obs_[-1])
res_obs_r = c(res_obs_[-length(res_obs_)], NA)
res_obs_r
res_obs_l
## Compute ACs
res_obs_l = c(NA, res_obs_)
res_obs_r = c(res_obs_, NA)
res_obs_l
res_obs_r
cor(res_obs_l, res_obs_r, na.rm=T)
cor(res_obs_l, res_obs_r)
## Compute ACs
res_obs_l = c(res_obs_[length(res_obs_)], res_obs_[-length(res_obs_)])
res_obs_r = c(res_obs_[-1], res_obs_[1])
res_obs_r
res_obs_l
res_obs_
cor(res_obs_l, res_obs_r)
plot(1:10, cex=0, ylim=c(-3,3), xlim=c(0,12))
for (i in 1:100)
{
## Get site and observations
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
## Compute ACs
res_obs_l = c(res_obs_[length(res_obs_)], res_obs_[-length(res_obs_)])
res_obs_r = c(res_obs_[-1], res_obs_[1])
cor_ = cor(res_obs_l, res_obs_r)
## Draw
col = rainbow(100)[round(runif(1,1,100))]
points(i, cor_, col=col)
}
plot(1:10, cex=0, ylim=c(-1,1), xlim=c(0,12))
for (i in 1:100)
{
## Get site and observations
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
## Compute ACs
res_obs_l = c(res_obs_[length(res_obs_)], res_obs_[-length(res_obs_)])
res_obs_r = c(res_obs_[-1], res_obs_[1])
cor_ = cor(res_obs_l, res_obs_r)
## Draw
col = rainbow(100)[round(runif(1,1,100))]
points(i, cor_, col=col)
}
length(sites_obs_msampled)
## Computing temporal ACs for multiple sites
cor_vector_obs = NULL
for (i in 1:length(sites_obs_msampled))
{
## Get site and observations
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
## Compute ACs
res_obs_l = c(res_obs_[length(res_obs_)], res_obs_[-length(res_obs_)])
res_obs_r = c(res_obs_[-1], res_obs_[1])
cor_ = cor(res_obs_l, res_obs_r)
## Collect
cor_vector_obs = c(cor_vector_obs, cor_)
}
## Visualise
barplot(cor_vector_obs)
## Computing temporal ACs for multiple sites
cor_vector_obs = NULL
for (i in 1:length(sites_obs_msampled))
{
## Get site and observations
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
## Compute ACs
res_obs_l = c(res_obs_[length(res_obs_)], res_obs_[-length(res_obs_)])
res_obs_r = c(res_obs_[-1], res_obs_[1])
cor_ = cor(res_obs_l, res_obs_r)
## Collect
cor_vector_obs = c(cor_vector_obs, cor_)
}
## Visualise
barplot(cor_vector_obs)
high_correlations = which(cor_vector_obs == 1)
high_correlations
sites_obs_msampled[idx_high_correlations[1]]
idx_high_correlations = which(cor_vector_obs == 1)
sites_obs_msampled[idx_high_correlations[1]]
print(res_obs[which(sites_obs == sites_obs_msampled[idx_high_correlations[1]])])
## Getting multiple sample sites
idx_msample_obs = which(table(sites_obs) > 2)
idx_msample_mis = which(table(sites_mis) > 2)
sites_obs_msampled = names(table(sites_obs))[idx_msample_obs]
sites_mis_msampled = names(table(sites_mis))[idx_msample_mis]
## Looking at residual time series for multiple sites
plot(1:10, cex=0, ylim=c(-3,3), xlim=c(0,12))
for (i in 1:100)
{
col = rainbow(100)[round(runif(1,1,100))]
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
lines(1:length(res_obs_), res_obs_, col=col)
}
## Computing temporal ACs for multiple sites
cor_vector_obs = NULL
for (i in 1:length(sites_obs_msampled))
{
## Get site and observations
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
## Compute ACs
res_obs_l = c(res_obs_[length(res_obs_)], res_obs_[-length(res_obs_)])
res_obs_r = c(res_obs_[-1], res_obs_[1])
cor_ = cor(res_obs_l, res_obs_r)
## Collect
cor_vector_obs = c(cor_vector_obs, cor_)
}
## Visualise
barplot(cor_vector_obs)
lines(c(1, length(cor_vector_obs)), c(0.25,0.25))
## Visualise
barplot(cor_vector_obs)
lines(c(1, length(cor_vector_obs)), c(0.25,0.25))
lines(c(1, length(cor_vector_obs)*10), -c(0.25,0.25))
barplot(cor_vector_obs)
lines(c(1, length(cor_vector_obs)*10), c(0.25,0.25), lty=2)
lines(c(1, length(cor_vector_obs)*10), -c(0.25,0.25), lty=2)
barplot(cor_vector_obs)
lines(c(0, length(cor_vector_obs)*10), c(0.25,0.25), lty=2)
lines(c(0, length(cor_vector_obs)*10), -c(0.25,0.25), lty=2)
hist(cor_vector_obs)
barplot(cor_vector_obs)
lines(c(0, length(cor_vector_obs)*10), c(0.25,0.25), lty=2)
lines(c(0, length(cor_vector_obs)*10), -c(0.25,0.25), lty=2)
## Computing temporal ACs for multiple sites
cor_vector_mis = NULL
## Getting multiple sample sites
idx_msample_obs = which(table(sites_obs) > 2)
idx_msample_mis = which(table(sites_mis) > 2)
sites_obs_msampled = names(table(sites_obs))[idx_msample_obs]
sites_mis_msampled = names(table(sites_mis))[idx_msample_mis]
## Computing temporal ACs for multiple sites
cor_vector_mis = NULL
for (i in 1:length(sites_mis_msampled))
{
## Get site and miservations
site = sites_mis_msampled[i]
res_mis_ = res_mis[which(sites_mis == site)]
## Compute ACs
res_mis_l = c(res_mis_[length(res_mis_)], res_mis_[-length(res_mis_)])
res_mis_r = c(res_mis_[-1], res_mis_[1])
cor_ = cor(res_mis_l, res_mis_r)
## Collect
cor_vector_mis = c(cor_vector_mis, cor_)
}
## Visualise
barplot(cor_vector_mis)
lines(c(0, length(cor_vector_mis)*10), c(0.25,0.25), lty=2)
lines(c(0, length(cor_vector_mis)*10), -c(0.25,0.25), lty=2)
# hist(cor_vector_mis)
## Getting multiple sample sites
idx_msample_obs = which(table(sites_obs) > 2)
idx_msample_mis = which(table(sites_mis) > 2)
sites_obs_msampled = names(table(sites_obs))[idx_msample_obs]
sites_mis_msampled = names(table(sites_mis))[idx_msample_mis]
sites_mis_msampled
## Computing temporal ACs for multiple sites
cor_vector_obs = NULL
for (i in 1:length(sites_obs_msampled))
{
## Get site and observations
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
## Compute ACs
res_obs_l = c(res_obs_[length(res_obs_)], res_obs_[-length(res_obs_)])
res_obs_r = c(res_obs_[-1], res_obs_[1])
cor_ = cor(res_obs_l, res_obs_r)
## Collect
cor_vector_obs = c(cor_vector_obs, cor_)
}
## Visualise
barplot(cor_vector_obs)
lines(c(0, length(cor_vector_obs)*10), c(0.25,0.25), lty=2)
lines(c(0, length(cor_vector_obs)*10), -c(0.25,0.25), lty=2)
# hist(cor_vector_obs)
frac_msampled_obs = sites_obs_msampled/length(table(sites_obs))
## Fraction of multiply sampled sites
frac_msampled_obs = length(sites_obs_msampled)/length(table(sites_obs))
frac_msampled_obs
prop_msampled_obs = length(sites_obs_msampled)/length(table(sites_obs))
print(prop_msampled_obs)
boxplot(cor_vector_obs)
boxplot(cor_vector_obs, ylim=c(-1,1))
quantile(cor_vector_obs, probs = c(0.05,0.95))
barplot(cor_vector_obs)
lines(c(0, length(cor_vector_obs)*10), c(0.25,0.25), lty=2)
lines(c(0, length(cor_vector_obs)*10), -c(0.25,0.25), lty=2)
## Computing temporal ACs for multiple sites
cor_vector_obs = NULL
for (i in 1:length(sites_obs_msampled))
{
## Get site and observations
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
## Compute ACs
res_obs_l = c(res_obs_[length(res_obs_)], res_obs_[-length(res_obs_)])
res_obs_ll = c(res_obs_l[length(res_obs_l)], res_obs_l[-length(res_obs_l)])
res_obs_r = c(res_obs_[-1], res_obs_[1])
res_obs_rr = c(res_obs_r[-1], res_obs_r[1])
cor_ = 0.5 * cor(res_obs_l, res_obs_r) + 0.5 * cor(res_obs_ll, res_obs_rr)
## Collect
cor_vector_obs = c(cor_vector_obs, cor_)
}
## Visualise
barplot(cor_vector_obs)
lines(c(0, length(cor_vector_obs)*10), c(0.25,0.25), lty=2)
lines(c(0, length(cor_vector_obs)*10), -c(0.25,0.25), lty=2)
barplot(cor_vector_obs, ylim=c(-1,1))
lines(c(0, length(cor_vector_obs)*10), c(0.25,0.25), lty=2)
lines(c(0, length(cor_vector_obs)*10), -c(0.25,0.25), lty=2)
## Computing temporal ACs for multiple sites
cor_vector_obs = NULL
for (i in 1:length(sites_obs_msampled))
{
## Get site and observations
site = sites_obs_msampled[i]
res_obs_ = res_obs[which(sites_obs == site)]
## Compute ACs
res_obs_l = c(res_obs_[length(res_obs_)], res_obs_[-length(res_obs_)]) # left tacking (lag 1)
res_obs_ll = c(res_obs_l[length(res_obs_l)], res_obs_l[-length(res_obs_l)]) # left left tacking (lag 2)
res_obs_lll = c(res_obs_ll[length(res_obs_ll)], res_obs_ll[-length(res_obs_ll)])
res_obs_r = c(res_obs_[-1], res_obs_[1]) # right tacking (lag 1)
res_obs_rr = c(res_obs_r[-1], res_obs_r[1]) # right right tacking (lag 2)
res_obs_rrr = c(res_obs_rr[-1], res_obs_rr[1])
cor_ = 1/3 * cor(res_obs_l, res_obs_r) + 1/3 * cor(res_obs_ll, res_obs_rr) + 1/3 * cor(res_obs_lll, res_obs_rrr)
## Collect
cor_vector_obs = c(cor_vector_obs, cor_)
}
## Visualise
barplot(cor_vector_obs, ylim=c(-1,1))
lines(c(0, length(cor_vector_obs)*10), c(0.25,0.25), lty=2)
lines(c(0, length(cor_vector_obs)*10), -c(0.25,0.25), lty=2)
barplot(abs(cor_vector_obs), ylim=c(-1,1))
lines(c(0, length(cor_vector_obs)*10), c(0.25,0.25), lty=2)
lines(c(0, length(cor_vector_obs)*10), -c(0.25,0.25), lty=2)
print(quantile(abs(cor_vector_obs), probs = c(0.025, 0.095)))
print(quantile(abs(cor_vector_obs), probs = c(0.025, 0.95)))
print(quantile(abs(cor_vector_obs), probs = c(0.25, 0.95)))
print(quantile(abs(cor_vector_obs), probs = c(0.05, 0.95)))
print(quantile(abs(cor_vector_obs), probs = c(0.975)))
barplot(abs(cor_vector_obs), ylim=c(0,1))
lines(c(0, length(cor_vector_obs)*10), c(0.25,0.25), lty=2)
lines(c(0, length(cor_vector_obs)*10), -c(0.25,0.25), lty=2)
print(quantile(abs(cor_vector_obs), probs = c(0.975))) # ~ p(abs(rho) > 0.44) <= 0.05
